<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Roue de la Fortune ‚Äì Maliterie</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet"/>
<style>
  :root{ --size:380; --red:#e03636; --blue:#2e5bb7; --bg:#0d202a; }
  *{box-sizing:border-box}
  body{margin:0; font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#0b1a22; color:#fff; display:flex; min-height:100vh; align-items:center; justify-content:center; padding:16px}
  .card{ width:min(95vw,620px); background:rgba(13,32,42,.95); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:24px; box-shadow:0 35px 80px rgba(0,0,0,.55) }
  h1{margin:0 0 8px; font-size:1.6rem}
  p{margin:0 0 14px; color:#dfe6f2}
  .stage{position:relative; width:calc(var(--size) * 1px); height:calc(var(--size) * 1px + 60px); margin:14px auto}
  .cursor{ position:absolute; top:-2px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:14px solid transparent; border-right:14px solid transparent; border-top:24px solid var(--red); z-index:3 }
  .wheel{ transition:transform 4s cubic-bezier(.17,.86,.27,1.02); transform-origin:50% 50% }
  button{ background:var(--blue); color:#fff; border:none; padding:12px 18px; border-radius:12px; font-weight:800; cursor:pointer; display:block; margin:8px auto 0 }
  .result{ text-align:center; margin-top:14px; font-weight:900 }
  .gate{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.65); z-index:5 }
  .gate[hidden]{ display:none!important }
  .gate form{ width:min(92vw,480px); background:#111827; border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px }
  .row{ display:grid; gap:6px; margin-bottom:10px }
  label{ font-size:14px; color:#d1d5db }
  input{ padding:12px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.1); background:#0f172a; color:#fff; outline:none }
  .error{ color:#ef4444; min-height:18px; font-size:13px; margin-top:2px }
</style>
</head>
<body>
  <div class="card">
    <h1>Roue de la fortune</h1>
    <p>Appuyez sur ‚ÄúLancer‚Äù pour tenter votre chance.</p>

    <div class="stage" id="stage">
      <div class="cursor"></div>
      <svg id="svg" width="100%" height="calc(var(--size) * 1px)" viewBox="0 0 380 380" aria-label="Roue">
        <defs>
          <filter id="drop" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur in="SourceAlpha" stdDeviation="6"/>
            <feOffset dx="0" dy="8" result="off"/>
            <feComponentTransfer><feFuncA type="linear" slope=".35"/></feComponentTransfer>
            <feMerge><feMergeNode in="off"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>
        <g id="wheel" class="wheel" filter="url(#drop)"></g>
        <circle cx="190" cy="190" r="175" fill="none" stroke="#ffffff" stroke-width="8"/>
        <circle cx="190" cy="190" r="34" fill="#fff"/>
      </svg>
    </div>

    <button id="spinBtn">Lancer</button>
    <div class="result" id="result" aria-live="polite"></div>
  </div>

  <!-- Pop-up d‚Äôidentification -->
  <div class="gate" id="gate">
    <form id="gateForm">
      <h3 style="margin:0 0 10px">Identifiez-vous</h3>
      <div class="row">
        <label for="prenom">Pr√©nom *</label>
        <input id="prenom" name="prenom" required />
      </div>
      <div class="row">
        <label for="nom">Nom *</label>
        <input id="nom" name="nom" required />
      </div>
      <div class="row">
        <label for="magasin">Magasin *</label>
        <input id="magasin" name="magasin" placeholder="ex: Paris Op√©ra" required />
      </div>
      <div class="error" id="gateErr"></div>
      <button type="submit">Acc√©der</button>
    </form>
  </div>

<script>
/* -------- CONFIG -------- */
const WORKER_URL = 'https://maliterie-capture.parmaktdm.workers.dev'; // ‚Üê mets ton URL

/* -------- Donn√©es roue (8 cases) -------- */
const gains = [
  "Linge de lit", "-30%", "Le Matelas", "-5%",
  "Un oreiller", "-30%", "Linge de lit", "-5%"
];

// Probas (on √©vite -5%)
const RAW_WEIGHTS = [
  { label: "Le Matelas", p: 0.006 },
  { label: "Linge de lit", p: 0.20 },
  { label: "Un oreiller", p: 0.05 },
  { label: "-30%",       p: 0.74 },
  { label: "-5%",        p: 0.00 }
];
const WEIGHTS = (()=>{ const s=RAW_WEIGHTS.reduce((a,b)=>a+(b.p||0),0)||1; return RAW_WEIGHTS.map(x=>({label:x.label,p:x.p/s})); })();

/* -------- Construction visuelle -------- */
const CX=190, CY=190, R_OUT=170, R_IN=56, R_TEXT=115;
const wheel=document.getElementById('wheel');
const SEG=gains.length, A=2*Math.PI/SEG;
function polar(r,a){return [CX+r*Math.cos(a),CY+r*Math.sin(a)]}
function makeSlice(i){
  const a0=-Math.PI/2+i*A,a1=a0+A;
  const [x0o,y0o]=polar(R_OUT,a0),[x1o,y1o]=polar(R_OUT,a1);
  const [x0i,y0i]=polar(R_IN,a1), [x1i,y1i]=polar(R_IN,a0);
  const largeArc=A>Math.PI?1:0;
  return `M${x0o} ${y0o}A${R_OUT} ${R_OUT} 0 ${largeArc} 1 ${x1o} ${y1o}L${x0i} ${y0i}A${R_IN} ${R_IN} 0 ${largeArc} 0 ${x1i} ${y1i}Z`;
}
function addLabel(g,i,text){
  const mid=-Math.PI/2+(i+0.5)*A;
  const [tx,ty]=polar(R_TEXT,mid);
  const n="http://www.w3.org/2000/svg";
  const group=document.createElementNS(n,'g'); group.setAttribute('transform',`translate(${tx},${ty})`);
  const t=document.createElementNS(n,'text'); t.setAttribute('text-anchor','middle'); t.setAttribute('dominant-baseline','middle'); t.setAttribute('font-size','14'); t.setAttribute('font-weight','800'); t.setAttribute('fill','#0f2733');
  t.textContent=text; group.appendChild(t); g.appendChild(group);
}
for(let i=0;i<SEG;i++){
  const n="http://www.w3.org/2000/svg";
  const path=document.createElementNS(n,'path');
  path.setAttribute('d', makeSlice(i));
  path.setAttribute('fill', i%2===0 ? '#e9eef9' : '#dbe4f5');
  path.setAttribute('stroke', '#ffffff'); path.setAttribute('stroke-width','1');
  wheel.appendChild(path);
  addLabel(wheel, i, gains[i]);
}

/* -------- Tirage + envoi -------- */
const resultEl=document.getElementById('result');
const spinBtn=document.getElementById('spinBtn');
let spinning=false, currentRot=0;
const pointerAngle=-90;

function weightedPick(){
  for(let k=0;k<40;k++){
    const r=Math.random(); let acc=0;
    for(const {label,p} of WEIGHTS){ acc+=p; if(r<acc){ if(label==='-5%') break; return label; } }
  }
  return "-30%";
}
function pickIndexFor(prize){
  const idx=gains.map((g,i)=>g.toLowerCase()===prize.toLowerCase()?i:-1).filter(i=>i!==-1);
  if(idx.length) return idx[Math.floor(Math.random()*idx.length)];
  const safe=gains.map((g,i)=>g!=='-5%'?i:-1).filter(i=>i!==-1);
  return safe[Math.floor(Math.random()*safe.length)];
}
function formatGain(g){
  if (/^[-+]?\d+%$/.test(g)) return g + " de r√©duction";
  return g;
}

async function sendToWorker(prize){
  const u = window.__gate_user__ || {};
  const now = new Date();
  const payload = {
    nom: u.nom || "Inconnu",
    prenom: u.prenom || "Inconnu",
    magasin: u.magasin || "Inconnu",
    date: `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`,
    heure: `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`,
    prize: prize || ""
  };
  try {
    await fetch(WORKER_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
  } catch(e){ console.warn('Envoi Worker √©chou√© (non bloquant)', e); }
}

function spin(){
  if(spinning) return;
  spinning=true; resultEl.textContent='';
  const segDeg=360/SEG;

  let prize=weightedPick();
  const index=pickIndexFor(prize);
  prize=gains[index];

  const centerDeg=-90 + index*segDeg + segDeg/2;
  const base=pointerAngle - centerDeg;
  const extra=5 + Math.floor(Math.random()*2);
  const final=extra*360 + base;

  currentRot += final;
  wheel.style.transform=`rotate(${currentRot}deg)`;

  setTimeout(async ()=>{
    resultEl.textContent = `üéâ Gain: ${formatGain(prize)}`;
    await sendToWorker(prize);
    spinning=false;
  }, 4000);
}

spinBtn.addEventListener('click', spin);

/* -------- Pop-up identit√© -------- */
const gate=document.getElementById('gate');
const form=document.getElementById('gateForm');
const err=document.getElementById('gateErr');

window.__gate_user__ = null;
gate.hidden = false;

form.addEventListener('submit', (e)=>{
  e.preventDefault();
  const prenom=(form.prenom.value||'').trim();
  const nom=(form.nom.value||'').trim();
  const magasin=(form.magasin.value||'').trim();
  if(!prenom || !nom || !magasin){ err.textContent='Merci de compl√©ter tous les champs.'; return; }
  window.__gate_user__ = { prenom, nom, magasin };
  gate.hidden = true;
});
</script>
</body>
</html>
