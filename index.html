<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Roue du bon sommeil ‚Äì Maliterie</title>

<!-- Police -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet"/>

<style>
  :root{
    --navy:#0f2733; --blue:#2e5bb7; --red:#e03636; --white:#ffffff;
    --size: 380;
    --spin-duration: 4s;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--white);
    font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    display:flex; flex-direction:column; align-items:center;
    overflow-x:hidden;
    background: url('https://media.admagazine.fr/photos/65846400cb76969786b9660c/16:9/w_2560%2Cc_limit/1433133399') center / cover no-repeat fixed;
  }
  header{ width:100%; padding:8px 0 0; position:relative; z-index:2; }
  .hero-logo{ max-width:clamp(260px, 55vw, 520px); margin:0 auto; padding:0 3vw; }
  .hero-logo img{ display:block; width:100%; height:auto; max-height:clamp(64px, 14vw, 110px); object-fit:contain; }
  .game{
    width:min(92vw, 560px); margin:20px auto; text-align:center;
    background:rgba(13,32,42,.92);
    border:1px solid rgba(255,255,255,.08);
    border-radius:18px; padding:24px 20px 28px;
    box-shadow:0 35px 80px rgba(0,0,0,.55),0 12px 30px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.04);
    backdrop-filter: blur(2px);
  }
  .game h1{margin:0 0 6px; font-size:1.6rem; font-weight:700}
  .game p{margin:0 0 12px; color:rgba(255,255,255,.9); font-weight:500}
  .stage{position:relative; width:calc(var(--size) * 1px); height:calc(var(--size) * 1px + 70px); margin:8px auto 0;}
  .cursor{
    position:absolute; top:-2px; left:50%; transform:translateX(-50%); width:0; height:0; z-index:3;
    border-left:14px solid transparent; border-right:14px solid transparent; border-top:24px solid var(--red);
    position:absolute; top:-2px; left:50%; transform:translateX(-50%);
    width:0; height:0; z-index:3;
    border-left:14px solid transparent; border-right:14px solid transparent;
    border-top:24px solid var(--red);
    filter:drop-shadow(0 6px 10px rgba(0,0,0,.55));
  }
  #fx{position:absolute; inset:0; pointer-events:none; z-index:4}
@@ -52,7 +54,7 @@
    box-shadow:0 14px 30px rgba(46,91,183,.45), 0 4px 10px rgba(0,0,0,.35);
    transition:transform .16s ease, box-shadow .2s ease, opacity .3s ease;
  }
  button:hover{ transform:translateY(-1px); box-shadow:0 18px 36px rgba(46,91,183,.5), 0 6px 14px rgba(0,0,0,.4);}
  button:hover{ transform:translateY(-1px); box-shadow:0 18px 36px rgba(46,91,183,.5), 0 6px 14px rgba(0,0,0,.4);} 
  button:active{ transform:translateY(0); }
  button.hidden{opacity:0; pointer-events:none;}
  .result{min-height:3.2em; margin-top:16px; font-weight:900; font-size:1.1rem; letter-spacing:.01em}
@@ -129,6 +131,7 @@

    <div class="btns">
      <button id="spinBtn">CLIQUER ICI</button>
      
    </div>

    <div id="result" class="result" aria-live="polite" aria-atomic="true"></div>
@@ -138,36 +141,6 @@
    <audio id="bigWinAudio" src="./bigwin.mp3" preload="auto" crossorigin="anonymous"></audio>
  </main>

<!-- =====================  CONFIG + ENVOI R√âSULTAT  ===================== -->
<script>
// ‚ö†Ô∏è REMPLACE ICI PAR TON ENDPOINT
const WORKER_URL = "https://ton-worker.example.com/collect";

// ---- helper: envoi du r√©sultat de la roue ----
async function sendSpinResult(prize, index) {
  try {
    const user = (window.GateForm && window.GateForm.getUserInfo && window.GateForm.getUserInfo()) || null;
    const payload = {
      type: "spin",                 // pour distinguer de la soumission de formulaire
      prize,                        // ex: "-30%", "Linge de lit", ...
      prizeIndex: index,            // index sur la roue (0..7)
      wheelTimestamp: new Date().toISOString(),
      // on rattache les infos de la personne si on les a :
      ...(user ? { prenom: user.prenom, nom: user.nom, magasin: user.magasin, formTimestamp: user.timestamp } : {})
    };

    await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      keepalive: true // utile si l‚Äôonglet se ferme juste apr√®s
    });
  } catch (err) {
    console.warn("‚ö†Ô∏è Envoi du r√©sultat de la roue √©chou√©", err);
  }
}
</script>

<script>
/* ================== Donn√©es visuelles (8 cases) ================== */
const gains = [
@@ -258,10 +231,10 @@
  shG.gain.exponentialRampToValueAtTime(0.0001,tS+0.5);
  sh.start(tS); sh.stop(tS+0.55);
}
function sadMelody(){ /* non utilis√© ici */ }
function sadMelody(){}
function isZeroPercentPrize(val){ return /^\s*[-+]?0%\s*$/.test(String(val).trim()); }

/* ====== Bus master (compresseur) & tons ====== */
/* ====== Bus master ====== */
let masterBus = null;
function getMasterBus(){
  if(!audioCtx) return null;
@@ -394,7 +367,6 @@
/* ================== Tirage pond√©r√© S√õR (jamais -5%) ================== */
const NORM = s => String(s).trim().toLowerCase();
function weightedPickSafe() {
  // tirage en fonction de WEIGHTS (normalis√©s) ; interdit -5%
  for (let guard=0; guard<50; guard++) {
    const r = Math.random();
    let acc = 0;
@@ -406,15 +378,13 @@
      }
    }
  }
  // fallback th√©orique si tout √©choue
  return "-30%";
}
function pickIndexForPrizeSafe(prize) {
  const indices = gains
    .map((g,i)=> NORM(g)===NORM(prize) ? i : -1)
    .filter(i=>i!==-1);
  if (indices.length) return indices[Math.floor(Math.random()*indices.length)];
  // si aucune case correspond, choisir n'importe quelle case ‚â† -5%
  const safeIndices = gains
    .map((g,i)=> NORM(g)!==NORM("-5%") ? i : -1)
    .filter(i=>i!==-1);
@@ -460,14 +430,10 @@

  const segAngleDeg=360/SEG;

  // 1) Tirage pond√©r√© s√ªr
  let prize = weightedPickSafe();
  // 2) Trouver une case correspondant au gain tir√© (toujours ‚â† -5%)
  const index = pickIndexForPrizeSafe(prize);
  // 3) Synchroniser l'intitul√© avec la case r√©ellement vis√©e
  prize = gains[index];

  // Calcul de la rotation
  const centerDeg = -90 + index*segAngleDeg + segAngleDeg/2;
  const base = pointerAngle - centerDeg;
  const extra = 5 + Math.floor(Math.random()*2);
@@ -484,13 +450,8 @@

  setTimeout(()=>{
    burstAt(bx, by, ['#2e5bb7','#ffffff','#e03636']);
    fanfare(); // son basique
    fanfare();
    resultEl.innerHTML = `<span class="pop">üéâ Vous avez gagn√© : ${formatGain(prize)}</span>`;

    // >>> ENVOI AU WORKER : prize + index + infos GateForm (si pr√©sentes)
    // pas de await pour ne pas bloquer l'UI ; erreurs silencieuses c√¥t√© console
    sendSpinResult(prize, index);

    spinning = false;
  }, 4040);
}
@@ -500,9 +461,8 @@
selfTestBtn && selfTestBtn.addEventListener('click', ()=> selfTest(100000));
</script>

<!-- =====================  AJOUT : Fen√™tre pop-up d'acc√®s  ===================== -->
<!-- =====================  AJOUT : Fen√™tre pop‚Äëup d'acc√®s  ===================== -->
<style>
  /* Styles isol√©s pour la fen√™tre d'identification */
  :root { --gate-ring:#2563eb; --gate-text:#e5e7eb; --gate-card:#111827; }
  body.gate-locked { overflow: hidden; }
  .gate-overlay { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(0,0,0,.65); backdrop-filter: blur(4px); z-index: 99999; padding: 24px; }
@@ -551,17 +511,19 @@
</div>

<script>
// √âvite toute double initialisation si le script est inclus deux fois
// √âvite double init si le script est inclus deux fois
(function(){
  if (window.__gate_initialized__) return; // garde-fou contre le double d√©marrage
  if (window.__gate_initialized__) return;
  window.__gate_initialized__ = true;

  const overlay = document.getElementById('gateOverlay');
  const form = document.getElementById('gateForm');
  const errorEl = document.getElementById('gateError');
  const resetBtn = document.getElementById('gateReset');

  // API minimale pour la page (pas de persistance inter-sessions)
  // ‚¨áÔ∏è REMPLACE par l'URL de ton Worker Cloudflare
  const WORKER_URL = 'https://maliterie-capture.parmaktdm.workers.dev';

  window.GateForm = {
    getUserInfo(){ return window.__gate_user__ || null; },
    clear(){ window.__gate_user__ = null; lock(); }
@@ -570,26 +532,51 @@
  function lock(){ overlay.hidden = false; document.body.classList.add('gate-locked'); setTimeout(()=>document.getElementById('gatePrenom')?.focus(),0); }
  function unlock(data){ overlay.hidden = true; document.body.classList.remove('gate-locked'); document.dispatchEvent(new CustomEvent('GateFormSubmitted', { detail: data })); }

  // Afficher UNE seule fois par chargement, et √† CHAQUE rafra√Æchissement de la page.
  // Pas de localStorage/sessionStorage pour ne rien m√©moriser entre reloads.
  lock();
  lock(); // afficher √† chaque rafra√Æchissement

  form.addEventListener('submit', (e)=>{
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    errorEl.textContent='';
    const prenom = (form.prenom.value||'').trim();
    const nom = (form.nom.value||'').trim();
    const magasin = (form.magasin.value||'').trim();
    if(!prenom || !nom || !magasin){ errorEl.textContent='Merci de compl√©ter tous les champs obligatoires.'; return; }
    const data = { prenom, nom, magasin, timestamp: new Date().toISOString() };

    const data = {
      prenom, nom, magasin,
      timestamp: new Date().toISOString(),
      meta: {
        page: location.href,
        referrer: document.referrer || '',
        userAgent: navigator.userAgent,
        tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
        lang: navigator.language
      }
    };

    // --------- Envoi au Worker Cloudflare (commit GitHub) ---------
    try {
      const resp = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      // On essaie de lire la r√©ponse (si CORS OK)
      try { const json = await resp.clone().json(); console.log('Worker response:', json); } catch {}
    } catch (err) {
      console.error('Envoi vers Worker √©chou√©', err);
      // On ne bloque pas l'acc√®s au jeu si l'envoi √©choue
    }
    // --------------------------------------------------------------

    window.__gate_user__ = data; // disponible pour ce chargement uniquement
    unlock(data);
  });

  resetBtn.addEventListener('click', ()=>{ form.reset(); errorEl.textContent=''; });
})();
</script>
<!-- =====================  FIN AJOUT FEN√äTRE POP-UP  ===================== -->
<!-- =====================  FIN AJOUT FEN√äTRE POP‚ÄëUP  ===================== -->

</body>
</html>
